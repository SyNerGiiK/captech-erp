{% extends "portal/base.html" %}
{% load portal_extras %}
{% block title %}Tickets - CapTech ERP{% endblock %}
{% block page_title %}Tickets{% endblock %}
{% block content %}

{% if company %}
  <div class="mb-6 flex items-center justify-between">
    <div class="text-ink-600">Entreprise : <span class="font-semibold text-ink-900">{{ company.name }}</span></div>
    <div class="flex gap-2">
      <a class="btn btn-dark" href="{% url 'portal:tickets_kanban' %}">Vue Kanban</a>
      <a class="btn btn-primary" href="{% url 'portal:ticket_create' %}">Nouveau ticket</a>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <form method="get" class="card p-4 space-y-3">
      <div class="font-medium">Filtres</div>
      <input class="w-full rounded border-slate-300" type="text" name="q" value="{{ request.GET.q }}" placeholder="Recherche…" />
      <div class="grid grid-cols-2 gap-3">
        <select class="rounded border-slate-300" name="status">
          <option value="">Statut (tous)</option>
          {% for k,v in status_choices %}
            <option value="{{ k }}" {% if request.GET.status == k %}selected{% endif %}>{{ v }}</option>
          {% endfor %}
        </select>
        <select class="rounded border-slate-300" name="priority">
          <option value="">Priorité (toutes)</option>
          {% for k,v in priority_choices %}
            <option value="{{ k }}" {% if request.GET.priority == k %}selected{% endif %}>{{ v }}</option>
          {% endfor %}
        </select>
        <input class="rounded border-slate-300" type="date" name="from" value="{{ request.GET.from }}">
        <input class="rounded border-slate-300" type="date" name="to" value="{{ request.GET.to }}">
      </div>
      <div class="flex gap-2">
        <button class="btn btn-dark">Filtrer</button>
        <a class="btn btn-outline" href="{% url 'portal:tickets' %}">Réinitialiser</a>
      </div>
    </form>

    <div class="lg:col-span-2 card">
      <div class="px-4 py-3 border-b border-slate-200 font-medium">Résultats</div>
      <div class="p-4 overflow-x-auto">
        {% if tickets %}
        <table class="w-full text-sm">
          <thead class="text-ink-500">
            <tr class="text-left">
              <th class="py-2">Titre</th>
              <th class="py-2">Statut</th>
              <th class="py-2">Priorité</th>
              <th class="py-2">Assigné</th>
              <th class="py-2">Créé</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200">
            {% for t in tickets %}
            <tr class="hover:bg-ink-50/60">
              <td class="py-2"><a class="font-medium hover:underline" href="{% url 'portal:ticket_detail' t.pk %}">{{ t.title }}</a></td>
              <td class="py-2">{{ t.get_status_display }}</td>
              <td class="py-2">
                <span class="chip {{ t.priority|priority_badge_class }}">{{ t.get_priority_display }}</span>
              </td>
              <td class="py-2">{{ t.assigned_to|default:"—" }}</td>
              <td class="py-2">{{ t.created_at }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
          <div class="text-sm text-ink-500">Aucun ticket.</div>
        {% endif %}
      </div>
    </div>
  </div>
{% else %}
  <div class="card p-6">Aucune entreprise associée.</div>
{% endif %}

{% endblock %}
